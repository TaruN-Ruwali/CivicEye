<!DOCTYPE html>
<html>
<head>
    <title>CivicEye | Admin Control</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-950 text-white p-12 font-sans">
    <div class="max-w-6xl mx-auto">
        <div class="flex justify-between items-end mb-10">
            <div>
                <h1 class="text-4xl font-black text-indigo-500 tracking-tighter">PWD BACKEND CONTROL</h1>
                <p class="text-slate-500 font-bold text-xs mt-1">REAL-TIME INFRASTRUCTURE MONITORING</p>
            </div>
            <div class="text-right">
                <p class="text-[10px] text-slate-500 font-bold uppercase tracking-widest">System Status</p>
                <p id="statusIndicator" class="font-bold text-sm transition-all duration-500">
                    Checking...
                </p>
            </div>
        </div>

        <div class="bg-slate-900 rounded-3xl overflow-hidden shadow-2xl border border-slate-800">
            <table class="w-full text-left">
                <thead class="bg-slate-800 text-slate-400">
                    <tr>
                        <th class="p-6 text-xs font-black">TICKET ID</th>
                        <th class="p-6 text-xs font-black">LOCATION</th>
                        <th class="p-6 text-xs font-black text-center">AI ACCURACY</th>
                        <th class="p-6 text-xs font-black text-right">REWARD</th>
                    </tr>
                </thead>
                <tbody id="tableBody">
                    </tbody>
            </table>
            <div id="offlineMsg" class="hidden p-4 bg-red-900/20 text-red-400 text-center text-xs font-bold border-t border-red-900/50">
                ⚠️ VIEWING OFFLINE DATA - SERVER DISCONNECTED
            </div>
        </div>
    </div>

    <script>
        const tableBody = document.getElementById('tableBody');
        const statusIndicator = document.getElementById('statusIndicator');
        const offlineMsg = document.getElementById('offlineMsg');

        async function fetchReports() {
            try {
                const r = await fetch('http://127.0.0.1:5000/api/reports');
                
                if (!r.ok) throw new Error("Server Down");

                const data = await r.json();

                // 1. Data ko Local Storage mein save karo (Emergency backup)
                localStorage.setItem('cached_reports', JSON.stringify(data));

                // 2. Status ko Green/Live karo
                statusIndicator.innerHTML = "● LIVE CONNECTED";
                statusIndicator.className = "text-green-500 font-bold text-sm animate-pulse";
                offlineMsg.classList.add('hidden');

                renderTable(data);

            } catch (e) {
                // 3. Agar server offline hai:
                statusIndicator.innerHTML = "● SYSTEM OFFLINE";
                statusIndicator.className = "text-red-600 font-bold text-sm";
                offlineMsg.classList.remove('hidden');

                // 4. Local storage se purana data uthao taaki table khali na dikhe
                const cachedData = localStorage.getItem('cached_reports');
                if (cachedData) {
                    renderTable(JSON.parse(cachedData));
                }
            }
        }

        function renderTable(data) {
            if (data.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="4" class="p-10 text-center text-slate-600 italic">No reports found in database.</td></tr>';
                return;
            }

            tableBody.innerHTML = data.map(i => `
                <tr class="border-b border-slate-800 hover:bg-slate-850 transition-colors">
                    <td class="p-6 font-mono text-indigo-400 font-bold">${i.id}</td>
                    <td class="p-6 text-slate-300 font-medium">${i.address}</td>
                    <td class="p-6 text-center">
                        <span class="bg-green-900/30 text-green-400 px-3 py-1 rounded-full text-xs font-black border border-green-800/50">
                            ${i.score}% Verified
                        </span>
                    </td>
                    <td class="p-6 text-right text-yellow-500 font-black text-lg">${i.points} Pts</td>
                </tr>
            `).join('');
        }

        // Har 3 second mein check karo
        setInterval(fetchReports, 3000);
        fetchReports();
    </script>
</body>
</html>